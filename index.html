<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rayray no Kiloma‚ÄôanÔΩúË±êÂπ¥Á•≠ÁöÑÁ®ãÂ∫è</title>
    <style>
        /* Basic page styles, Times New Roman first for English fonts */
        body { 
            font-family: "Times New Roman", "Noto Sans TC", sans-serif; 
            background-color: #f7f6ef; 
            color: #333; 
            margin: 0; 
            padding: 0; /* Remove body padding */
        }
        .container { max-width: 800px; margin: auto; text-align: center; padding: 1em; /* Move padding to container */ }
        
        /* --- ‚ú® New splash screen styles (renamed for hierarchy) --- */
        #splash-screen-0, #splash-screen-a, #splash-screen-b, #splash-screen-c { /* Added splash-screen-0 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s ease-out;
            overflow: hidden; /* Ensure video doesn't overflow */
        }
        #splash-screen-a, #splash-screen-b, #splash-screen-c { /* Initially hidden */
            display: none; 
        }

        #splash-video-0, #splash-video-a, #splash-video-b, #splash-video-c { /* Consolidated video styles */
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Ensure video is fully visible, not cropped, and fills the space */
            transform: translate(-50%, -50%);
            /* Ensure it fills the parent div while maintaining aspect ratio */
        }

        /* Removed splash-content-0 and splash-image-0 specific styles */
        /* Removed specific adjustments for splash-screen-b #splash-video-b as it's now unified */


        #enter-btn-0, #enter-btn-a, #enter-btn-b, #enter-btn-c { /* Added enter-btn-0 */
            position: relative;
            z-index: 2001;
            padding: 15px 35px;
            font-size: 1.5em;
            color: white;
            background-color: rgba(48, 80, 48, 0.7);
            border: 2px solid white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #enter-btn-0:hover, #enter-btn-a:hover, #enter-btn-b:hover, #enter-btn-c:hover { /* Added enter-btn-0 hover */
            background-color: rgba(48, 80, 48, 0.9);
            transform: scale(1.05);
        }
        
        /* ‚ú® Sound control buttons (renamed for hierarchy) */
        #volume-btn-0, #volume-btn-a, #volume-btn-b, #volume-btn-c { /* Added volume-btn-0 */
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 2001;
            background: rgba(0,0,0,0.4);
            color: white;
            border: 1px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* New back buttons for splash screens (renamed for hierarchy) */
        #back-btn-a, #back-btn-b, #back-btn-c { /* Added back-btn-a, back-btn-b, back-btn-c */
            position: absolute;
            top: 20px; 
            left: 20px; 
            z-index: 2001;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: white; 
            padding: 5px 10px;
        }
        #back-btn-a:hover, #back-btn-b:hover, #back-btn-c:hover { /* Added back-btn-a, back-btn-b, back-btn-c hover */
            color: #ccc;
        }

        #main-content {
            display: none; /* Default hidden main content */
            opacity: 0;
            transition: opacity 1s ease-in;
        }

        /* --- ‚ú® Header styles --- */
        .page-header {
            display: flex;
            justify-content: space-between; /* Align elements apart */
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid #e8e6d9;
            margin-bottom: 1.5em;
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .page-header .logo {
            max-height: 50px;
        }
        .page-header .instructor-name {
            font-size: 1em;
            color: #555;
            white-space: nowrap; /* Prevent instructor name from wrapping */
        }

        #back-btn {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #555;
            padding: 5px 10px;
        }
        #back-btn:hover {
            color: #000;
        }


        h1, h2 { text-align: center; color: #305030; }
        
        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: -10px;
        }

        /* --- ‚ú® Lesson navigation & Quiz sections --- */
        .lesson-nav, .quiz-section, .full-text-section {
            background-color: #e8e6d9;
            padding: 1.5em;
            border-radius: 12px;
            margin: 1.5em 0;
        }
        .lesson-nav h3, .quiz-section h3, .full-text-section h3 {
            margin-top: 0;
            color: #305030;
            border-bottom: 2px solid #c9c7b9;
            padding-bottom: 0.5em;
            margin-bottom: 1em;
        }
        .lesson-links {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .lesson-links a, .quiz-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
        }
        .lesson-links a:hover, .quiz-btn:hover {
            background-color: #305030;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* ‚ú® Online quiz section styles (Option 1: Focus on single quiz) */
        .quiz-content {
            padding: 1.5em 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .quiz-content p {
            margin: 0;
            font-size: 1.2em;
        }
        .quiz-item img {
            max-width: 250px;
            width: 100%;
            height: auto;
            border-radius: 12px;
            border: 3px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .quiz-btn {
            font-size: 1.2em;
            padding: 12px 28px;
        }
        
        /* ‚ú® Full text overview */
        .full-text-section .overview-container {
            position: relative;
        }
        .full-text-section img {
            max-width: 100%;
            border-radius: 8px;
            display: block;
        }

        .overview-play-btn {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.05); /* Adjusted to match other play buttons */
            border: 1px solid #ccc; /* Adjusted to match other play buttons */
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
            width: 40px; /* Matched size with .play-btn */
            height: 40px; /* Matched size with .play-btn */
            font-size: 1.5em; /* Matched font size with .play-btn */
        }
        .overview-play-btn:hover {
            background-color: #e9e9e9; /* Adjusted to match other play buttons */
        }

        /* Positions for overview buttons */
        /* These positions are now fine-tuned for better alignment with the image text and below yellow symbols */
        #overview-btn-title { top: 7.0%; left: 3.5%; } 
        #overview-btn-1 { top: 17.0%; left: 3.5%; } 
        #overview-btn-2 { top: 26.0%; left: 3.5%; } 
        #overview-btn-3 { top: 34.8%; left: 3.5%; } 
        #overview-btn-4 { top: 46.8%; left: 3.5%; } 
        #overview-btn-5 { top: 56.1%; left: 3.5%; } 
        #overview-btn-6 { top: 68.5%; left: 3.5%; } 
        #overview-btn-7 { top: 77.3%; left: 3.5%; } 
        #overview-btn-8 { top: 86.0%; left: 3.5%; } 


        /* --- New text and button layout --- */
        .lesson-content {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 2em;
            text-align: left;
            margin-top: 1.5em;
        }

        .sentence-line {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 1.5em;
        }
        
        .sentence-line:last-child {
            margin-bottom: 0;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .play-btn, .gemini-btn {
            background-color: rgba(0, 0, 0, 0.05);
            border: 1px solid #ccc;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            font-family: "Times New Roman", sans-serif; /* Ensure icon characters display */
        }
        
        .play-btn { width: 40px; height: 40px; font-size: 1.5em; }
        .gemini-btn { width: 32px; height: 32px; font-size: 0.9em; }

        .play-btn:hover, .gemini-btn:hover {
            background-color: #e9e9e9;
        }

        .sentence-text {
            flex-grow: 1;
            font-size: 1.5em;
            line-height: 1.8;
            margin: 0;
            padding-top: 5px;
        }

        /* ‚ú® Tap-to-translate styles */
        .word {
            cursor: pointer;
            border-bottom: 2px dotted #aaa;
            transition: background-color 0.2s;
        }
        .word:hover {
            background-color: #e8f4f8;
        }
        .word.highlighted-phrase { /* Style for highlighted phrase (red) */
            background-color: #ffcccc; /* Light red background */
            font-weight: bold;
        }
        .word.highlighted-single-word { /* Style for highlighted single word (blue) */
            background-color: #cceeff; /* Light blue background */
            font-weight: bold;
        }

        /* Translation tooltip */
        #tooltip {
            position: absolute;
            background-color: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1em;
            z-index: 1010;
            display: none; /* Default hidden */
            pointer-events: none; /* Prevent tooltip from blocking events */
        }
        
        /* --- Original Gemini buttons and Modal styles --- */
        .culture-btn {
            font-family: "Times New Roman", "Noto Sans TC", sans-serif;
            margin-top: 25px;
            padding: 12px 24px;
            font-size: 18px;
            background-color: #305030;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .culture-btn:hover { background-color: #486e48; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: #fff; padding: 30px; border-radius: 12px;
            width: 90%; max-width: 600px; max-height: 80vh;
            overflow-y: auto; position: relative; text-align: left; line-height: 1.8;
        }
        .modal-close {
            position: absolute; top: 15px; right: 15px; font-size: 28px;
            font-weight: bold; cursor: pointer; color: #888;
        }
        .modal-close:hover { color: #333; }
        .modal-title { margin-top: 0; color: #305030;}
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #305030;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* AI Chat Modal styles removed */

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .page-header {
                justify-content: space-between;
            }
            .header-info {
                gap: 10px;
            }
            .sentence-text {
                font-size: 1.2em; /* Smaller font size for mobile */
            }
            /* Adjusted for consistency on mobile */
            .play-btn { width: 35px; height: 35px; font-size: 1.3em;}
            .gemini-btn { width: 28px; height: 28px; font-size: 0.8em; }
            .overview-play-btn { 
                width: 35px; 
                height: 35px; 
                font-size: 1.3em;
            }
            /* Unified splash screen video styles for mobile */
            #splash-screen-0 #splash-video-0,
            #splash-screen-a #splash-video-a,
            #splash-screen-b #splash-video-b,
            #splash-screen-c #splash-video-c {
                position: absolute; /* Changed to absolute for full screen fill */
                top: 50%;
                left: 50%;
                width: 100%;
                height: 100%;
                object-fit: contain; /* Cover the whole area */
                transform: translate(-50%, -50%);
            }
        }
    </style>
</head>
<body>
    <!-- ‚ú® Splash Screen 0 (New First Page) -->
    <div id="splash-screen-0">
        <video id="splash-video-0" autoplay muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750694133/kiloma_an_p1_imabpm.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <button id="enter-btn-0">ÈÄ≤ÂÖ•Ë™≤Á®ã</button>
        <button id="volume-btn-0">üîà</button>
    </div>

    <!-- ‚ú® Splash Screen A (Original Splash 1, now 2nd page) -->
    <div id="splash-screen-a">
        <video id="splash-video-a" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750665618/%E5%A4%A7%E5%AF%8C%E7%BF%81%E5%8B%95%E7%95%AB_fwbjxs.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <button id="enter-btn-a">ÈÄ≤ÂÖ•Ë™≤Á®ã</button>
        <button id="volume-btn-a">üîà</button>
        <button id="back-btn-a">‚Ü©Ô∏è</button>
    </div>

    <!-- ‚ú® Splash Screen B (Original Splash 2, now 3rd page) -->
    <div id="splash-screen-b">
        <video id="splash-video-b" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750684378/kiloma_an_%E7%9A%84%E8%A4%87%E6%9C%AC_2_qjc4ix.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <button id="enter-btn-b">ÈÄ≤ÂÖ•Ë™≤Á®ã</button>
        <button id="volume-btn-b">üîà</button>
        <button id="back-btn-b">‚Ü©Ô∏è</button>
    </div>

    <!-- ‚ú® Splash Screen C (Original Splash 3, now 4th page) -->
    <div id="splash-screen-c">
        <video id="splash-video-c" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750689764/kiloma_an_%E7%9A%84%E8%A4%87%E6%9C%AC_6_vvz732.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <button id="enter-btn-c">ÈÄ≤ÂÖ•Ë™≤Á®ã</button>
        <button id="volume-btn-c">üîà</button>
        <button id="back-btn-c">‚Ü©Ô∏è</button>
    </div>

    <main id="main-content">
        <div class="container">
            
            <header class="page-header">
                <div class="header-left">
                    <button id="back-btn">‚Ü©Ô∏è</button>
                    <img src="https://res.cloudinary.com/dm1ksvptk/image/upload/v1750667116/ChatGPT_Image_2025%E5%B9%B46%E6%9C%886%E6%97%A5_%E4%B8%8B%E5%8D%8803_49_10_g50dif.png" alt="Ëá∫Êù±Á∏£Êú¨ÂúüË™ûÊïôÂ≠∏ Logo" class="logo">
                    <p class="instructor-name">Ëá∫Êù±Á∏£Êú¨ÂúüË™ûÂúò</p>
                </div>
                <div class="header-right">
                    <p class="instructor-name">ÊéàË™≤ÊïôÂ∏´ÔºöËòøÊãâÈ∫ªÂêâ Rolla Moggi</p>
                    <img src="https://res.cloudinary.com/dm1ksvptk/image/upload/v1749659604/vxem1akzssudvs0neffn.png" alt="Logo" class="logo">
                </div>
            </header>

            <div class="title-container">
                <h1>Rayray no Kiloma‚Äôan</h1>
                <button class="play-btn" data-audio="audio-title">‚ñ∂</button>
            </div>
            <h2>üìñ Ë±êÂπ¥Á•≠ÁöÑÁ®ãÂ∫èÔΩúË™≤ÊñáÊúóËÆÄÁ∑¥Áøí</h2>

            <!-- ‚ú® Lesson navigation section -->
            <nav class="lesson-nav">
                <h3>ÊñáÂåñË™≤Á®ãÂàóË°®</h3>
                <ul class="lesson-links">
                    <li><a href="https://www.youtube.com/watch?v=zkV900qsffY" target="_blank" rel="noopener noreferrer">Á¨¨1Â†ÇË™≤ÔºöË±êÂπ¥Á•≠ÁöÑ‰ªãÁ¥π</a></li>
                    <li><a href="https://www.youtube.com/watch?v=cxPQUPFRUfI" target="_blank" rel="noopener noreferrer">Á¨¨2Â†ÇË™≤ÔºöÈ¶¨Ëò≠Ë±êÂπ¥Á•≠</a></li>
                    <li><a href="https://youtu.be/3O6G_ujIM2I" target="_blank" rel="noopener noreferrer">Á¨¨2Â†ÇË™≤ÔºöÈÉΩËò≠Ë±êÂπ¥Á•≠</a></li>
                    <li><a href="https://www.youtube.com/watch?v=dKtyTTbKBvs" target="_blank" rel="noopener noreferrer">Á¨¨3Â†ÇË™≤ÔºöË§áÈü≥Âî±Ê≥ï‰ªãÁ¥π</a></li>
                    <li><a href="https://reurl.cc/VYvR5y" target="_blank" rel="noopener noreferrer">Á¨¨3Â†ÇË™≤ÔºöÈ¶¨Ëò≠Ë§áÈü≥Ê≠åË¨†</a></li>
                    <li><a href="https://www.facebook.com/watch/?v=800065338528852" target="_blank" rel="noopener noreferrer">Á¨¨4Â†ÇË™≤ÔºöÂ∞ëÂπ¥ÁµÑÂ≠∏Áøí</a></li>
                    <li><a href="https://www.youtube.com/watch?v=haXUddf3Ygs" target="_blank" rel="noopener noreferrer">Á¨¨4-1Â†ÇË™≤ÔºöÂ©¶Â•≥ÁµÑÊ≠åËàû</a></li>
                    <li><a href="https://www.youtube.com/watch?v=6milVeLkKN8" target="_blank" rel="noopener noreferrer">Á¨¨4-2Â†ÇË™≤ÔºöÂãáÂ£´Ë≠∑Ë°õËàû</a></li>
                    <li><a href="https://www.youtube.com/watch?v=GDurQY3ECTo" target="_blank" rel="noopener noreferrer">Á¨¨5Â†ÇË™≤ÔºöÂÇ≥Áµ±Ê≠åËàû</a></li>
                    <li><a href="https://www.youtube.com/watch?v=ochU3S1gQNg" target="_blank" rel="noopener noreferrer">Á¨¨5Â†ÇË™≤ÔºöÁèæ‰ª£Ëàû</a></li>
                    <li><a href="https://rollamoggi123.github.io/rayray-no-kiloma-an-no-singsi/" target="_blank" rel="noopener noreferrer">ÊïôÂ∏´Á§∫ÁØÑÁâàÂ§ßÂØåÁøÅ</a></li>
                    <li><a href="https://rollamoggi123.github.io/rayray-no-kiloma-an-no-mitiliday/" target="_blank" rel="noopener noreferrer">ÊóèË™ûÂ§ßÂØåÁøÅÔºö‰∫íÂãïÊïôÂ≠∏Áâà</a></li>
                </ul>
            </nav>

            <!-- ‚ú® Full text overview section -->
            <section class="full-text-section">
                <h3>Ë™≤ÊñáÁ∏ΩË¶Ω</h3>
                <div class="overview-container">
                    <img src="https://res.cloudinary.com/dm1ksvptk/image/upload/v1750658706/lesson_text_fxfgbh.png" alt="Ë™≤ÊñáÂÖ®ÊñáÂúñÁâá">
                    <button class="play-btn overview-play-btn" data-audio="audio-title" id="overview-btn-title">‚ñ∂</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-1" id="overview-btn-1">‚ñ∂</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-2" id="overview-btn-2">‚ñ∂</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-3" id="overview-btn-3">‚ñ∂</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-4" id="overview-btn-4">‚ñ∂</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-5" id="overview-btn-5">‚ñ∂</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-6" id="overview-btn-6">‚ñ∂</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-7" id="overview-btn-7">‚ñ∂</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-8" id="overview-btn-8">‚ñ∂</button>
                </div>
            </section>

            <div class="lesson-content">
                <!-- Sentence content -->
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-title">‚ñ∂</button>
                        <button class="gemini-btn" data-text="Rayray no Kiloma‚Äôan.">üí°</button>
                    </div>
                    <p class="sentence-text">
                        Rayray no Kiloma‚Äôan.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-1">‚ñ∂</button>
                        <button class="gemini-btn" data-text="Faloay ko romi'ad to kiloma‚Äôan no Farangaw.">üí°</button>
                    </div>
                    <p class="sentence-text">
                        Faloay ko romi'ad to kiloma‚Äôan no Farangaw.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-2">‚ñ∂</button>
                        <button class="gemini-btn" data-text="Sa'ayaw a romi'ad misahafay, mirekal i taliyok no niyaro', milikakawa to lalosidan.">üí°</button>
                    </div>
                    <p class="sentence-text">
                        Sa'ayaw a romi'ad misahafay, mirekal i taliyok no niyaro', milikakawa to lalosidan.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-3">‚ñ∂</button>
                        <button class="gemini-btn" data-text="Sakatosa a romi'ad panemnem, tahidang to liteng, misatora, pacaedong to miromromay, mitaowak to kaetohay.">üí°</button>
                    </div>
                    <p class="sentence-text">
                        Sakatosa a romi'ad panemnem, tahidang to liteng, misatora, pacaedong to miromromay, mitaowak to kaetohay.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-4">‚ñ∂</button>
                        <button class="gemini-btn" data-text="Sakatolo a romi'ad, pafata'an pacelem na malingad talariyal mikesi'.">üí°</button>
                    </div>
                    <p class="sentence-text">
                        Sakatolo a romi'ad, pafata'an pacelem na malingad talariyal mikesi'.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-5">‚ñ∂</button>
                        <button class="gemini-btn" data-text="Sakasepat ato sakalima a romi'ad, saromi'ad mikesi' i riyal, micelem, micekiw mipacing ko kapah, ta palaylay minokay.">üí°</button>
                    </div>
                    <p class="sentence-text">
                        Sakasepat ato sakalima a romi'ad, saromi'ad mikesi' i riyal, micelem, micekiw mipacing ko kapah, ta palaylay minokay.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-6">‚ñ∂</button>
                        <button class="gemini-btn" data-text="Sakaenem a romi'ad misahemay, malikoda ko kapah, patayra i sefi to faes ko fafahiyan, palilam to titi.">üí°</button>
                    </div>
                    <p class="sentence-text">
                        Sakaenem a romi'ad misahemay, malikoda ko kapah, patayra i sefi to faes ko fafahiyan, palilam to titi.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-7">‚ñ∂</button>
                        <button class="gemini-btn" data-text="Sakapito a romi'ad pipipay, mapolong ko finawlan maaides, masakero ato malalefod, horirek panokay to liteng.">üí°</button>
                    </div>
                    <p class="sentence-text">
                        Sakapito a romi'ad pipipay, mapolong ko finawlan maaides, masakero ato malalefod, horirek panokay to liteng.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-8">‚ñ∂</button>
                        <button class="gemini-btn" data-text="Saikoray a romi'ad mipakerang ko kapot.">üí°</button>
                    </div>
                    <p class="sentence-text">
                        Saikoray a romi'ad mipakerang ko kapot.
                    </p>
                </div>
            </div>
            
            <!-- ‚ú® Online quiz section -->
            <section class="quiz-section">
                <h3>Á¨¨1Â†ÇË™≤ÔºöÁ´ãÂç≥ÂÖ®Áè≠Ê∏¨È©ó</h3>
                <div class="quiz-content">
                    <p>Please click the button below or scan the QR Code to enter the quiz.</p>
                    <a href="https://wayground.com/join?gc=339281" class="quiz-btn" target="_blank" rel="noopener noreferrer">Enter Quiz for Lesson 1</a>
                </div>
            </section>

            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 25px;">
                <button id="culture-btn" class="culture-btn">‚ú® Explore Harvest Festival Culture</button>
            </div>
        </div>
    </main>

    <!-- Hidden audio players etc. -->
    <audio id="audio-title" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750657545/%E8%AA%B2%E6%96%87rayray_no_kiloma_an_k7hpsw.mp3"></audio>
    <audio id="audio-1" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750657974/line2_gti8hy.mp3"></audio>
    <audio id="audio-2" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658020/line3_blpsw6.mp3"></audio>
    <audio id="audio-3" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658115/line4_ngh0nr.mp3"></audio>
    <audio id="audio-4" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658179/line5_omltw4.mp3"></audio>
    <audio id="audio-5" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658270/line6_pf2hef.mp3"></audio>
    <audio id="audio-6" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658330/line7_fg4jqm.mp3"></audio>
    <audio id="audio-7" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658390/line8_qkssrh.mp3"></audio>
    <audio id="audio-8" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658429/line9_txq625.mp3"></audio>

    <!-- Translation tooltip -->
    <div id="tooltip"></div>

    <!-- Modal pop-up window -->
    <div id="gemini-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3 class="modal-title">AI Â∞èËÄÅÂ∏´</h3>
            <div id="modal-body"><div class="loader"></div></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- ‚ú® Splash screen logic (updated for stability) ---
            let currentScreen = 'splash0'; // Start at the very first splash screen

            const splashScreen0 = document.getElementById('splash-screen-0'); 
            const splashVideo0 = document.getElementById('splash-video-0'); 
            const enterBtn0 = document.getElementById('enter-btn-0'); 
            const volumeBtn0 = document.getElementById('volume-btn-0'); 

            const splashScreenA = document.getElementById('splash-screen-a'); 
            const splashVideoA = document.getElementById('splash-video-a');
            const enterBtnA = document.getElementById('enter-btn-a');
            const volumeBtnA = document.getElementById('volume-btn-a');
            const backBtnA = document.getElementById('back-btn-a'); 

            const splashScreenB = document.getElementById('splash-screen-b'); 
            const splashVideoB = document.getElementById('splash-video-b');
            const enterBtnB = document.getElementById('enter-btn-b');
            const volumeBtnB = document.getElementById('volume-btn-b');
            const backBtnB = document.getElementById('back-btn-b'); 

            const splashScreenC = document.getElementById('splash-screen-c'); 
            const splashVideoC = document.getElementById('splash-video-c');
            const enterBtnC = document.getElementById('enter-btn-c');
            const volumeBtnC = document.getElementById('volume-btn-c');
            const backBtnC = document.getElementById('back-btn-c'); 

            const mainContent = document.getElementById('main-content');
            const backBtn = document.getElementById('back-btn'); 

            const transitionTo = (target) => {
                let currentActiveScreen;
                let currentVideo;
                if (currentScreen === 'splash0') { currentActiveScreen = splashScreen0; currentVideo = splashVideo0; }
                else if (currentScreen === 'splasha') { currentActiveScreen = splashScreenA; currentVideo = splashVideoA; }
                else if (currentScreen === 'splashb') { currentActiveScreen = splashScreenB; currentVideo = splashVideoB; }
                else if (currentScreen === 'splashc') { currentActiveScreen = splashScreenC; currentVideo = splashVideoC; }
                else if (currentScreen === 'main') currentActiveScreen = mainContent;

                // Pause current video if any
                if (currentVideo && !currentVideo.paused) {
                    currentVideo.pause();
                }

                currentActiveScreen.style.opacity = '0';
                currentActiveScreen.addEventListener('transitionend', function handler() {
                    currentActiveScreen.style.display = 'none';
                    currentActiveScreen.removeEventListener('transitionend', handler);

                    let nextActiveScreen;
                    let nextVideo;
                    if (target === 'splash0') { nextActiveScreen = splashScreen0; nextVideo = splashVideo0; }
                    else if (target === 'splasha') { nextActiveScreen = splashScreenA; nextVideo = splashVideoA; }
                    else if (target === 'splashb') { nextActiveScreen = splashScreenB; nextVideo = splashVideoB; }
                    else if (target === 'splashc') { nextActiveScreen = splashScreenC; nextVideo = splashVideoC; }
                    else if (target === 'main') { nextActiveScreen = mainContent; }

                    if (nextVideo) {
                        nextVideo.currentTime = 0; // Rewind
                        // Handle AbortError for video play attempts
                        nextVideo.play().then(() => {
                            console.log(`Successfully played: ${target} video.`);
                        }).catch(error => {
                            if (error.name === 'AbortError') {
                                console.warn(`Video playback for ${target} was aborted (likely by user quick-clicking).`);
                            } else {
                                console.error(`Error playing video for ${target}:`, error);
                            }
                        });
                    }

                    nextActiveScreen.style.display = (target.startsWith('splash')) ? 'flex' : 'block'; 
                    void nextActiveScreen.offsetWidth; // Trigger reflow
                    nextActiveScreen.style.opacity = '1';
                    currentScreen = target;
                }, { once: true });
            };

            enterBtn0.addEventListener('click', () => transitionTo('splasha')); 
            enterBtnA.addEventListener('click', () => transitionTo('splashb')); 
            enterBtnB.addEventListener('click', () => transitionTo('splashc')); 
            enterBtnC.addEventListener('click', () => transitionTo('main')); 

            backBtn.addEventListener('click', () => { 
                if (currentScreen === 'main') {
                    transitionTo('splashc'); 
                } 
            });

            backBtnC.addEventListener('click', () => { 
                if (currentScreen === 'splashc') {
                    transitionTo('splashb');
                }
            });

            backBtnB.addEventListener('click', () => { 
                if (currentScreen === 'splashb') {
                    transitionTo('splasha');
                }
            });

            backBtnA.addEventListener('click', () => { 
                if (currentScreen === 'splasha') {
                    transitionTo('splash0');
                }
            });


            volumeBtn0.addEventListener('click', () => {
                splashVideo0.muted = !splashVideo0.muted;
                volumeBtn0.textContent = splashVideo0.muted ? 'üîà' : 'üîä';
            });
            volumeBtnA.addEventListener('click', () => {
                splashVideoA.muted = !splashVideoA.muted;
                volumeBtnA.textContent = splashVideoA.muted ? 'üîà' : 'üîä';
            });
            volumeBtnB.addEventListener('click', () => {
                splashVideoB.muted = !splashVideoB.muted;
                volumeBtnB.textContent = volumeBtnB.muted ? 'üîà' : 'üîä'; 
            });
            volumeBtnC.addEventListener('click', () => { 
                splashVideoC.muted = !splashVideoC.muted;
                volumeBtnC.textContent = volumeBtnC.muted ? 'üîà' : 'üîä';
            });

            // Initial state: show splash screen 0
            splashScreen0.style.display = 'flex';
            splashVideo0.play().then(() => {
                console.log("Initial splash0 video played successfully.");
            }).catch(error => {
                if (error.name === 'NotAllowedError') {
                    console.warn("Autoplay for splash0 blocked. User interaction needed.");
                } else if (error.name !== 'AbortError') {
                    console.error("Error playing initial splash0 video:", error);
                }
            });


            // --- ‚ú® Smart Dictionary (updated) ---
            const vocabulary = {
                "Rayray": "Á®ãÂ∫è", 
                "Faloay": "ÂÖ´ (Êï∏Â≠ó)", 
                "ko": "‰∏ªÊ†º", 
                "romi'ad": "Â§©; Â§©Ê∞£", 
                "to": "ÊñúÊ†º", 
                "kiloma‚Äôan": "Ë±êÂπ¥Á•≠", "no": "ÔºàÂ±¨Ê†ºÔºâ",
                "Farangaw": "È¶¨Ëò≠Á§æ", 
                "Sa'ayaw": "ÊúÄÂÖà", 
                "Sa'ayaw_a_romi'ad": "Á¨¨‰∏ÄÂ§©", 
                "misahafay": "Ê∫ñÂÇôÊó•",
                "mirekal": "Â†±Ë®ä", 
                "i": "Âú®... (‰ªãÁπ´Ë©û)", 
                "taliyok_no_niyaro'": "ÈÉ®ËêΩÂë®Âúç",
                "milikakawa": "Ê∫ñÂÇôÂô®ÂÖ∑/ÂïüÁ®ã", 
                "lalosidan": "ÂÇ≥Áµ±Âô®ÂÖ∑",
                "Sakatosa_a_romi'ad": "Á¨¨‰∫åÂ§©", "panemnem": "Áµ¶Ê≥âÊ∞¥", "tahidang_to_liteng": "ËøéË´ãÁ•ñÈùà",
                "misatora": "Á•àÈùà", "pacaedong_to_miromromay": "ÈùíÂπ¥È†òÂ∞éÊé•Âèó‰∫§‰ªªÂãô",
                "mitaowak_to_kaetohay": "È£≤Áõ°Ëí∏È§æÈÖí", "Sakatolo_a_romi'ad": "Á¨¨‰∏âÂ§©",
                "pafata'an_pacelem": "‰∏ÄÊó©Ê∏ÖÈªû‰∫∫Êï∏", 
                "na_malingad_talariyal_mikesi'": "ÊâçÂá∫ÁôºÂà∞Êµ∑ÈÇäËàâË°åÊµ∑Á•≠", 
                "Sakasepat_ato_sakalima_a_romi'ad": "Á¨¨Âõõ„ÄÅ‰∫îÂ§©", 
                "saromi'ad_mikesi'_i_riyal": "ÈùíÂπ¥Êï¥Â§©Âú®Êµ∑ÈÇä", // Corrected original: saromi'ad mikesi' i riyal
                "micelem": "ÊΩõÊ∞¥", "micekiw": "Êé°ÈõÜËû∫Ë≤ùÈ°û", "mipacing_ko_kapah": "ÈùíÂπ¥Â∞ÑÈ≠ö",
                "ta_palaylay_minokay": "ÊâçÂæûÊµ∑ÈÇäË∑≥ÂãáÂ£´ËàûÂõûÂà∞ËÅöÊúÉÊâÄ", 
                "palaylay": "ÂãáÂ£´Ëàû", 
                "minokay": "ÂõûÂÆ∂", 
                "Sakaenem_a_romi'ad": "Á¨¨ÂÖ≠Â§©",
                "misahemay": "ÊêóÊùµÈÄ†È£Ø(Ë£Ω‰ΩúÁ≥ØÁ±≥È£Ø)", "malikoda_ko_kapah": "ÈùíÂπ¥Â§ßÊúÉËàû",
                "patayra_i_sefi_to_faes_ko_fafahiyan": "Â•≥ÊÄßÂ∏∂Á±≥ÂéªÂú®ËÅöÊúÉÊâÄ",
                "palilam_to_titi": "ÂàÜËÇâ", "Sakapito_a_romi'ad_pipipay": "Á¨¨‰∏ÉÂ§©(ÊØîË≥ΩÊó•)",
                "mapolong_ko_finawlan_maaides": "ÂÖ®È´îÊóè‰∫∫Áõ∏‰∫íËºÉÂãÅ", "masakero": "Ë∑≥Ëàû", "ato": "Âíå",
                "malalefod": "‰∫íÁõ∏Ë≥ΩË∑ë", 
                "horirek_panokay_to_liteng": "ÂÆåÊàêÂæåÈÄÅÁ•ñÈùàÂõûÂÆ∂",
                "panokay": "ÈÄÅÂõûÂÆ∂", 
                "Saikoray": "ÊúÄÂæå", 
                "Saikoray_a_romi'ad": "ÊúÄÂæå‰∏ÄÂ§©", 
                "mipakerang": "ÂÆåÂ∑•Á•≠", 
                "mipakerang_ko_kapot": "Âπ¥ÈΩ°ÈöéÂ±§ÈÄ≤Ë°åÂÆåÂ∑•Á•≠",
                "kapah": "ÈùíÂπ¥", 
                "fafahiyan": "Â•≥ÊÄß", 
                "faes": "Á≥ØÁ±≥", 
                "mapolong": "ÂÖ®È´î", 
                "finawlan": "Êóè‰∫∫" 
            };

            const allPlayButtons = document.querySelectorAll('.play-btn');
            const allPlayers = document.querySelectorAll('.audio-player');
            const geminiExplainButtons = document.querySelectorAll('.gemini-btn');
            const cultureBtn = document.getElementById('culture-btn');
            const geminiModal = document.getElementById('gemini-modal');
            const modalCloseBtn = geminiModal.querySelector('.modal-close');
            const modalTitle = geminiModal.querySelector('.modal-title');
            const modalBody = document.getElementById('modal-body'); 
            const tooltip = document.getElementById('tooltip');

            let currentHighlightedWord = null; // Track the currently highlighted word span

            // Function to create clickable word spans
            function createClickableSpans(sentenceText, vocab) {
                let resultHtml = '';
                let tempText = sentenceText; 
                
                // Sort vocabulary keys by length in descending order to prioritize longer phrases
                const sortedKeys = Object.keys(vocab).sort((a, b) => b.length - a.length);

                // Placeholder map to store already processed spans
                const processedSpans = new Map();
                let placeholderCounter = 0;

                // First pass: identify and replace multi-word phrases with placeholders
                for (const key of sortedKeys) {
                    // Check if the key corresponds to a multi-word phrase (contains underscore)
                    // or if it's explicitly a known multi-word phrase like the title.
                    // IMPORTANT: Ensure the regex pattern correctly handles apostrophes and spaces within phrases.
                    let pattern;
                    if (key.includes('_')) {
                        pattern = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').replace(/_/g, '[\\s‚Äô\\-]*');
                    } else {
                        // For single words or keys without underscore, match them directly.
                        pattern = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    }
                    
                    // Regex to find occurrences. Use a non-capturing group for the pattern itself.
                    // Add word boundaries for more precise matching of whole words/phrases.
                    const regex = new RegExp(`\\b(${pattern})\\b`, 'gi'); 
                    
                    // Use a temporary string for replacement to avoid issues with already wrapped content
                    let newTempText = tempText.replace(regex, (match) => {
                        // Only replace if it's not a placeholder from a previous, longer match
                        if (!match.startsWith('__PH_')) { 
                            const placeholder = `__PH_${placeholderCounter++}__`;
                            // Store the original matched text with its data-key
                            processedSpans.set(placeholder, `<span class="word" data-key="${key}">${match}</span>`);
                            return placeholder;
                        }
                        return match; // If it's already a placeholder, return it as is
                    });
                    // Only update tempText if changes were made by this regex
                    if (newTempText !== tempText) {
                        tempText = newTempText;
                    }
                }

                // Second pass: Reconstruct the HTML from segments and restore processed spans
                let finalParts = [];
                // Split by the generated placeholders to process the remaining plain text parts
                const segments = tempText.split(/(__PH_\d+__)/g);

                segments.forEach(segment => {
                    if (segment.startsWith('__PH_') && processedSpans.has(segment)) {
                        finalParts.push(processedSpans.get(segment)); // Restore the previously wrapped phrase
                    } else {
                        // Process the remaining plain text segment for single words that might not have been part of a multi-word phrase
                        // This regex matches sequences of word characters (including optional internal apostrophes) or individual non-word characters (like punctuation, spaces)
                        const individualTokens = segment.match(/(\b\w+'?\w*\b|[^\w\s])/g); 
                        
                        if (individualTokens) {
                            individualTokens.forEach(token => {
                                let cleanedToken = token.replace(/[,.'‚Äô\s]/g, ''); 
                                if (vocab[cleanedToken]) {
                                    finalParts.push(`<span class="word" data-key="${cleanedToken}">${token}</span>`);
                                } else {
                                    finalParts.push(token); // Add original token if no vocabulary match
                                }
                            });
                        } else {
                            finalParts.push(segment); // Fallback if segment cannot be further tokenized
                        }
                    }
                });

                return finalParts.join('').trim();
            }


            const sentences = [
                "Rayray no Kiloma‚Äôan.",
                "Faloay ko romi'ad to kiloma‚Äôan no Farangaw.",
                "Sa'ayaw a romi'ad misahafay, mirekal i taliyok no niyaro', milikakawa to lalosidan.",
                "Sakatosa a romi'ad panemnem, tahidang to liteng, misatora, pacaedong to miromromay, mitaowak to kaetohay.",
                "Sakatolo a romi'ad, pafata'an pacelem na malingad talariyal mikesi'.",
                "Sakasepat ato sakalima a romi'ad, saromi'ad mikesi' i riyal, micelem, micekiw mipacing ko kapah, ta palaylay minokay.",
                "Sakaenem a romi'ad misahemay, malikoda ko kapah, patayra i sefi to faes ko fafahiyan, palilam to titi.",
                "Sakapito a romi'ad pipipay, mapolong ko finawlan maaides, masakero ato malalefod, horirek panokay to liteng.", 
                "Saikoray a romi'ad mipakerang ko kapot."
            ];

            const sentenceElements = document.querySelectorAll('.lesson-content .sentence-line');
            sentenceElements.forEach((lineElement, index) => {
                const playButton = lineElement.querySelector('.play-btn');
                const geminiButton = lineElement.querySelector('.gemini-btn');
                const sentenceTextElement = lineElement.querySelector('.sentence-text');
                
                // Update data-text for gemini button with Amis sentence
                geminiButton.dataset.text = sentences[index];

                // Manually construct the clickable spans for the Amis sentence text
                sentenceTextElement.innerHTML = createClickableSpans(sentences[index], vocabulary);
            });
            
            // --- Audio playback logic (fixed) ---
            allPlayButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const targetAudioId = button.dataset.audio;
                    const targetPlayer = document.getElementById(targetAudioId);
                    console.log(`Attempting to play: ${targetAudioId}`); // Log which audio is being targeted
                    if (!targetPlayer) {
                        console.error(`Audio element not found: ${targetAudioId}`);
                        return;
                    }

                    const isCurrentlyPlaying = !targetPlayer.paused;

                    if (isCurrentlyPlaying) {
                        targetPlayer.pause();
                        console.log(`Paused: ${targetAudioId}`);
                    } else {
                        allPlayers.forEach(p => {
                            if (p !== targetPlayer) {
                                p.pause();
                                p.currentTime = 0; // Rewind paused audios
                                console.log(`Paused and rewound other audio: ${p.id}`);
                            }
                        });
                        targetPlayer.play().then(() => {
                            console.log(`Successfully played: ${targetAudioId}`);
                        }).catch(error => { // Changed 'err' to 'error' for consistency
                            if (error.name === 'NotAllowedError') {
                                console.warn(`Autoplay/playback blocked for ${targetAudioId}. User interaction may be required.`);
                            } else if (error.name === 'AbortError') { // Catch AbortError specifically
                                console.warn(`Playback for ${targetAudioId} was aborted (expected in rapid transitions).`);
                            }
                            else {
                                console.error(`Playback error for ${targetAudioId}:`, error);
                            }
                        });
                    }
                });
            });

            allPlayers.forEach(player => {
                // Update button text when audio plays
                player.addEventListener('play', () => {
                    const btns = document.querySelectorAll(`[data-audio="${player.id}"]`);
                    btns.forEach(btn => {
                        btn.textContent = '‚ùö‚ùö'; // Set pause icon
                    });
                });

                // Update button text when audio pauses or ends
                player.addEventListener('pause', () => { 
                    const btns = document.querySelectorAll(`[data-audio="${player.id}"]`);
                    btns.forEach(btn => {
                        btn.textContent = '‚ñ∂'; // Set play icon
                    });
                });

                // Ensure icon resets when audio finishes naturally
                player.addEventListener('ended', () => {
                    const btns = document.querySelectorAll(`[data-audio="${player.id}"]`);
                    btns.forEach(btn => {
                        btn.textContent = '‚ñ∂'; // Set play icon
                    });
                });
            });
            
            // --- Gemini API call logic (for detailed explanation) ---
            const callGemini = async (prompt, modalBodyElement) => {
                modalBodyElement.innerHTML = '<div class="loader"></div>';

                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API request failed, status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Unexpected response format from API.');
                    }
                } catch (error) {
                    console.error('Gemini API call failed:', error);
                    return `ÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ<br>(${error.message})`;
                }
            };
            
            // --- Modal general logic ---
            const setupModal = (modalElement) => { 
                const closeBtn = modalElement.querySelector('.modal-close');
                
                closeBtn.addEventListener('click', () => modalElement.style.display = 'none');
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) {
                        modalElement.style.display = 'none';
                    }
                });
            };

            setupModal(geminiModal);

            // --- Tap-to-translate logic (Enhanced for highlighting and positioning) ---
            const wordsContainer = document.querySelector('.lesson-content'); // Container for words
            wordsContainer.addEventListener('click', (e) => {
                // Clear highlight from previously highlighted word/phrase
                if (currentHighlightedWord) {
                    currentHighlightedWord.classList.remove('highlighted-phrase');
                    currentHighlightedWord.classList.remove('highlighted-single-word');
                    currentHighlightedWord = null;
                }
                tooltip.style.display = 'none'; // Hide tooltip on any click outside a word

                // Check if the clicked element is a word span
                let targetWordSpan = e.target.closest('.word');

                if (targetWordSpan) {
                    e.stopPropagation(); // Prevent document.body click from immediately hiding tooltip
                    
                    const key = targetWordSpan.dataset.key;
                    const translation = vocabulary[key];
                    
                    if (translation) {
                        tooltip.textContent = translation;
                        const rect = targetWordSpan.getBoundingClientRect();
                        
                        // Temporarily show tooltip to get its dimensions
                        tooltip.style.display = 'block';
                        const tooltipHeight = tooltip.offsetHeight;
                        const tooltipWidth = tooltip.offsetWidth;
                        
                        // Calculate positions
                        const spaceAbove = rect.top;
                        const spaceBelow = window.innerHeight - rect.bottom;
                        
                        let topPosition;
                        if (spaceAbove > tooltipHeight + 5) { // Prefer above if enough space
                            topPosition = rect.top + window.scrollY - tooltipHeight - 5;
                        } else if (spaceBelow > tooltipHeight + 5) { // Otherwise, prefer below if enough space
                            topPosition = rect.bottom + window.scrollY + 5;
                        } else { // Fallback: try to place below, centered on screen vertically if too little space
                            topPosition = rect.bottom + window.scrollY + 5; // Default to below
                            // Could add more complex logic here to prevent going off-screen on very small viewports
                        }

                        let leftPosition = rect.left + window.scrollX + (rect.width / 2) - (tooltipWidth / 2);
                        // Adjust if it goes off left edge
                        if (leftPosition < 5) {
                            leftPosition = 5;
                        }
                        // Adjust if it goes off right edge
                        if (leftPosition + tooltipWidth > window.innerWidth - 5) {
                            leftPosition = window.innerWidth - tooltipWidth - 5;
                        }


                        tooltip.style.left = `${leftPosition}px`;
                        tooltip.style.top = `${topPosition}px`;
                        
                        // Determine if it's a multi-word phrase or single word for highlighting
                        // Check if the vocabulary key itself contains '_' for a multi-word phrase,
                        // as the `createClickableSpans` function already sets data-key based on best match.
                        if (key.includes('_')) { 
                            targetWordSpan.classList.add('highlighted-phrase'); // Red for phrases
                        } else {
                            targetWordSpan.classList.add('highlighted-single-word'); // Blue for single words
                        }
                        currentHighlightedWord = targetWordSpan;
                    }
                }
            });

            // Hide tooltip and remove highlight when clicking anywhere else on the body
            document.body.addEventListener('click', () => {
                tooltip.style.display = 'none';
                if (currentHighlightedWord) {
                    currentHighlightedWord.classList.remove('highlighted-phrase');
                    currentHighlightedWord.classList.remove('highlighted-single-word');
                    currentHighlightedWord = null;
                }
            });


            // --- Sentence explanation & cultural exploration logic ---
            geminiExplainButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const sentence = button.dataset.text;

                    modalTitle.innerText = 'üìñ Ë©≥Á¥∞ a Panangilawlawag'; // Detailed Explanation
                    geminiModal.style.display = 'flex';
                    const prompt = `Based on the following "Correct Word Definitions", translate the Amis sentence "${sentence}" into Traditional Chinese, and explain its grammatical structure and vocabulary in a bulleted list. Please explain in a way that is easy for beginners to understand.

**Correct Word Definitions:**
* Faloay: Eight (number)
* a romi'ad: Day (a is a connective)
* ko: Is a subject marker
* no: Possessive marker
* to: Oblique case marker
* mirekal: Announce news
* taliyok no niyaro': Around the tribe/village
* milikakawa: Prepare tools/Depart
* lalosidan: Traditional tools
* misahafay: Preparation day
* panemnem: Give spring water
* tahidang to liteng: Invite ancestral spirits
* misatora: Spirit offering
* pacaedong to miromromay: Youth leaders receive assignments
* mitaowak to kaetohay: Drink all the distilled wine
* pafata'an pacelem: Count people early in the morning
* na_malingad_talariyal_mikesi': Just set off for the seaside to hold a sea ritual
* Sakasepat_ato_sakalima_a_romi'ad: Fourth and fifth day
* saromi'ad_mikesi'_i_riyal: Youth perform sea ritual all day at the seaside
* micelem: Dive
* micekiw: Gather shellfish
* mipacing ko kapah: Youth fish with arrows
* ta_palaylay_minokay: Just danced warrior dance and returned home from the seaside
* misahemay: Pound glutinous rice (to make rice cakes)
* malikoda_ko_kapah: Youth perform grand tribal dance
* patayra_i_sefi_to_faes_ko_fafahiyan: Females bring glutinous rice to the gathering place
* palilam_to_titi: Distribute meat
* Sakapito_a_romi'ad_pipipay: Seventh day (competition day)
* mapolong_ko_finawlan_maaides: All tribespeople compete with each other
* masakero: Dance
* ato: And
* malalefod: Race each other
* horirek_panokay_to_liteng: After completion, send ancestral spirits home
* Saikoray_a_romi'ad: Last day
* mipakerang_ko_kapot: Age-grade groups perform completion ritual
* Rayray: Procedure
* a: Connective particle
* i: At/in (preposition)
* romi'ad: Day; Weather
* mipakerang: Completion ritual
* Sa'ayaw: Foremost/First
* Saikoray: Last
* palaylay: Warrior dance
* minokay: Go home
* panokay: Send home
* kapah: Youth
* fafahiyan: Female
* faes: Glutinous rice
* mapolong: All/Entire
* finawlan: Tribe people

**Analyze target sentence:**
"${sentence}"

**Your response format should be as follows:**
**Chinese Translation:** [Translate here]

**Word Analysis:**
* [Word 1]: [Explanation 1]
* [Word 2]: [Explanation 2]

**Grammar Structure:**
* [Grammar Point 1]: [Explanation 1]
* [Grammar Point 2]: [Explanation 2]`;
                    const responseText = await callGemini(prompt, modalBody);
                    modalBody.innerHTML = responseText.replace(/\n/g, '<br>');
                });
            });

            cultureBtn.addEventListener('click', async () => {
                modalTitle.innerText = '‚ú® Explore Harvest Festival Culture'; // Explore Harvest Festival Culture
                geminiModal.style.display = 'flex';
                // Construct full text from sentences array for cultural context.
                // Assuming `sentences` array contains only the Amis text now.
                const fullText = sentences.join('\n'); 

                const prompt = `I am learning about the Amis Harvest Festival (Kiloma'an) in Taiwan, based on the following Amis text. Please, from the perspective of a language learner interested in culture, provide a detailed explanation in Traditional Chinese of the cultural background and significance of the Harvest Festival, and explain the cultural meaning of the procedures mentioned in this text (e.g., misahafay, panemnem, mikesi', etc.).

**Lesson content for reference:**
${fullText}`;
                const responseText = await callGemini(prompt, modalBody);
                modalBody.innerHTML = responseText.replace(/\n/g, '<br>');
            });
            
        });
    </script>
</body>
</html>
